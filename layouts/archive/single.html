<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light only">
  <title>{{ .Title }} | {{ site.Data.setup.title }}</title>
  {{ partial "components/favicon.html" | safeHTML }}

  <!-- Pico CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

  <!-- Alpine.js + Fuse.js -->
  <script defer src="/js/alpine-3.11.1.min.js"></script>
  <script src="/js/fuse.min.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    @font-face {
      font-family: "gagalin";
      src: local("Gagalin"), url("/fonts/Gagalin-Regular.woff") format("woff");
    }
    @font-face {
      font-family: "Inter UI";
      font-weight: 100 900;
      src: url("/fonts/Inter-3.19.var.woff2") format("woff2");
    }

    html {
      overflow-x: hidden;
    }

    body {
      overflow-y: scroll;
      width: 100%;
      max-width: 100vw;
    }

    :root {
      --half-padding: 8px;
      --base-padding: 16px;
      --double-padding: 32px;
      --primary: #ffde59;
      --inverse: #1f1f1f;
      --muted: #666666;
      --line: #e0e0e0;
      --hero-font: gagalin, sans-serif;
      --pico-font-family: "Inter UI", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    [x-cloak] {
      display: none !important;
    }

    body > header {
      background: var(--primary);
      color: var(--inverse);
    }

    body > header nav {
      column-gap: 0;
    }

    body > header a {
      color: var(--inverse);
      text-decoration: none;
    }

    .hero-text {
      font-family: var(--hero-font);
      font-style: italic;
      font-weight: 400;
    }

    .verybig-text { font-size: 180%; }

    main.container {
      padding: 2rem 1.25rem 2rem;
      background: white;
      display: grid;
      gap: 1.8rem;
    }

    main.container hgroup {
      margin-bottom: 0;
      max-width: 768px;
      margin: 0 auto;
    }

    main.container > label {
      margin: 0rem auto;
      width: 100%;
      max-width: 320px;
    }

    main.container > label input[type="search"] {
      margin: 0;
      width: 100%;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--line);
      border-radius: 0;
      padding: 0.5rem 0;
      box-shadow: none;
    }

    main > label input[type="search"]::-webkit-search-decoration,
    main > label input[type="search"]::-webkit-search-cancel-button {
      -webkit-appearance: none;
    }

    .section-title {
      text-transform: capitalize;
      display: flex;
      align-items: baseline;
    }

    .section-title .tag {
      margin-left: auto;
    }

    .tag {
      padding: 0.15em 0.4em;
      border-radius: 3px;
      background: var(--inverse);
      color: var(--primary);
      font-variant: normal;
      text-transform: none;
      font-size: 0.7em;
    }

    section ul {
      padding-left: 0;
      margin: 0;
    }

    section ul li {
      list-style: none;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--line);
      overflow-wrap: break-word;
      word-break: break-word;
    }

    section ul li:last-child {
      border-bottom: none;
    }

    section ul a {
      text-decoration: none;
      color: inherit;
      display: grid;
      grid-template-columns: 3.5em 1fr 5.5em;
      gap: 1rem;
      align-items: baseline;
    }

    section ul a.no-code {
      grid-template-columns: 1fr 5.5em;
    }

    section ul a span:not(.episode-date) {
      font-weight: bold;
    }

    section ul a small {
      white-space: nowrap;
      font-weight: bold;
      background: var(--line);
      color: var(--muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      padding: 0.15em 0.4em;
      border-radius: 3px;
      text-align: center;
    }

    .episode-date {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
    }

    details summary.group-meta,
    details summary.group-meta:focus,
    details summary.group-meta:hover,
    details[open] summary.group-meta {
      text-transform: uppercase;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      --pico-color: var(--muted);
      color: var(--muted);
    }

    .season-list {
      padding-left: 0;
      margin: 0;
    }

    .season-list > li {
      padding: 0;
      border: none;
    }

    .season-list ul {
      padding: 0;
      margin: 0;
    }

    mark {
      background: var(--primary);
      color: inherit;
      padding: 0 0.1em;
      border-radius: 2px;
    }

    footer {
      background: var(--inverse);
      color: var(--primary);
      padding: 2.5rem 1.25rem 1.75rem;
      margin-top: auto;
    }

    footer p:first-of-type {
      font-family: var(--hero-font);
      font-size: 1.5rem;
      font-style: italic;
      margin: 0 0 1.5rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    footer menu {
      padding: 0;
      margin: 0;
      list-style: none;
      display: grid;
      gap: 0.35rem;
    }

    footer small {
      display: block;
      margin-top: 1.5rem;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.75);
    }
  </style>
</head>
<body x-data="{
  filter: new URLSearchParams(location.search).get('tipo') || 'tutto',
  query: '',
  items: [
    {{- $allPages := where .Site.RegularPages "Type" "in" (slice "podcast" "articles") -}}
    {{- range $i, $p := $allPages }}{{ if $i }},{{ end }}
    {
      title: {{ $p.Title | jsonify }},
      type: {{ $p.Type | jsonify }},
      url: {{ $p.RelPermalink | jsonify }},
      season: {{ $p.Params.season | default 0 | jsonify }},
      number: {{ $p.Params.number | default 0 | jsonify }},
      date: {{ $p.Date.Format "2 Jan 2006" | jsonify }},
      timestamp: {{ $p.Date.Unix | jsonify }},
      description: {{ $p.Plain | truncate 300 | jsonify }},
      keywords: {{ delimit ($p.Params.keywords | default slice) " " | jsonify }},
      tags: {{ delimit ($p.Params.tags | default slice) " " | jsonify }}
    }
    {{- end }}
  ],
  fuse: null,

  init() {
    this.fuse = new Fuse(this.items, {
      keys: [
        { name: 'title', weight: 4 },
        { name: 'keywords', weight: 2 },
        { name: 'tags', weight: 2 },
        { name: 'description', weight: 1 }
      ],
      threshold: 0.2,
      ignoreLocation: true,
      minMatchCharLength: 2
    });

    this.$watch('filter', (val) => {
      const url = new URL(window.location);
      if (val === 'tutto') {
        url.searchParams.delete('tipo');
      } else {
        url.searchParams.set('tipo', val);
      }
      history.replaceState({}, '', url);
    });
  },

  get filteredItems() {
    let results = this.items;
    if (this.query.length >= 2) {
      results = this.fuse.search(this.query).map(r => r.item);
    }
    if (this.filter !== 'tutto') {
      const typeMap = { 'podcast': 'podcast', 'articoli': 'articles' };
      results = results.filter(i => i.type === typeMap[this.filter]);
    }
    return results;
  },

  highlightTitle(item) {
    if (!this.query || this.query.length < 2) {
      return this.escapeHtml(item.title);
    }
    const title = item.title;
    const query = this.query.toLowerCase();
    const lowerTitle = title.toLowerCase();
    const idx = lowerTitle.indexOf(query);
    if (idx === -1) {
      return this.escapeHtml(title);
    }
    return this.escapeHtml(title.slice(0, idx)) +
           '<mark>' + this.escapeHtml(title.slice(idx, idx + query.length)) + '</mark>' +
           this.escapeHtml(title.slice(idx + query.length));
  },

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },

  get podcasts() {
    return this.filteredItems
      .filter(i => i.type === 'podcast')
      .sort((a, b) => b.timestamp - a.timestamp);
  },
  get articles() {
    return this.filteredItems
      .filter(i => i.type === 'articles')
      .sort((a, b) => b.timestamp - a.timestamp);
  },
  get seasons() {
    const groups = new Map();
    this.podcasts.forEach(item => {
      const season = Number(item.season) || 0;
      if (!groups.has(season)) groups.set(season, []);
      groups.get(season).push(item);
    });
    return Array.from(groups.entries())
      .map(([season, episodes]) => ({
        season,
        episodes: episodes.sort((a, b) => b.timestamp - a.timestamp)
      }))
      .sort((a, b) => (b.season || 0) - (a.season || 0));
  },
  get years() {
    const groups = new Map();
    this.articles.forEach(item => {
      const year = item.date.split(' ').pop();
      if (!groups.has(year)) groups.set(year, []);
      groups.get(year).push(item);
    });
    return Array.from(groups.entries())
      .map(([year, articles]) => ({
        year,
        articles: articles.sort((a, b) => b.timestamp - a.timestamp)
      }))
      .sort((a, b) => b.year - a.year);
  },
  get podcastCount() { return this.podcasts.length; },
  get articleCount() { return this.articles.length; }
}">
  {{ partial "header.html" . }}

  <main class="container" x-cloak>

    <hgroup>
      <h1>{{ .Title }}</h1>
      <p>{{ .Params.subtitle | default "Qui puoi cercare episodi e articoli" }}</p>
    </hgroup>

    <label>
      <input type="search" x-model="query" placeholder="Cerca..." aria-label="Cerca nel catalogo">
    </label>

    <p x-show="filteredItems.length === 0"><em>Nessun risultato trovato.</em></p>

    <section x-show="podcasts.length > 0 && (filter === 'tutto' || filter === 'podcast')">
      <h2 class="section-title">Podcast <span class="tag" x-text="podcastCount"></span></h2>

      <!-- Con raggruppamento per season (senza ricerca) -->
      <ul x-show="query.length < 2" class="season-list" role="list">
        <template x-for="group in seasons" :key="group.season">
          <li>
            <details :open="group.season === seasons[0]?.season">
              <summary class="group-meta">Season <span x-text="group.season"></span></summary>
              <ul role="list">
                <template x-for="episode in group.episodes" :key="episode.url">
                  <li>
                    <a :href="episode.url">
                      <small x-text="'S' + episode.season + 'E' + episode.number"></small>
                      <span x-html="highlightTitle(episode)"></span>
                      <span class="episode-date" x-text="episode.date"></span>
                    </a>
                  </li>
                </template>
              </ul>
            </details>
          </li>
        </template>
      </ul>

      <!-- Lista piatta (durante ricerca) -->
      <ul x-show="query.length >= 2" role="list">
        <template x-for="episode in podcasts" :key="episode.url">
          <li>
            <a :href="episode.url">
              <small x-text="'S' + episode.season + 'E' + episode.number"></small>
              <span x-html="highlightTitle(episode)"></span>
              <span class="episode-date" x-text="episode.date"></span>
            </a>
          </li>
        </template>
      </ul>
    </section>

    <section x-show="articles.length > 0 && (filter === 'tutto' || filter === 'articoli')">
      <h2 class="section-title">Articoli <span class="tag" x-text="articleCount"></span></h2>

      <!-- Con raggruppamento per anno (senza ricerca) -->
      <ul x-show="query.length < 2" class="season-list" role="list">
        <template x-for="group in years" :key="group.year">
          <li>
            <details :open="group.year === years[0]?.year">
              <summary class="group-meta"><span x-text="group.year"></span></summary>
              <ul role="list">
                <template x-for="article in group.articles" :key="article.url">
                  <li>
                    <a :href="article.url" class="no-code">
                      <span x-html="highlightTitle(article)"></span>
                      <span class="episode-date" x-text="article.date"></span>
                    </a>
                  </li>
                </template>
              </ul>
            </details>
          </li>
        </template>
      </ul>

      <!-- Lista piatta (durante ricerca) -->
      <ul x-show="query.length >= 2" role="list">
        <template x-for="article in articles" :key="article.url">
          <li>
            <a :href="article.url" class="no-code">
              <span x-html="highlightTitle(article)"></span>
              <span class="episode-date" x-text="article.date"></span>
            </a>
          </li>
        </template>
      </ul>
    </section>
  </main>

  <footer class="container">
    <p><a href="/">{{ site.Data.setup.title }}</a></p>
    <section>
      {{ $data := newScratch }}
      {{ $data.Set "essential" .Site.Taxonomies.categories.essential }}
      {{ $data.Set "footer" .Site.Taxonomies.categories.footer }}

      {{ range slice "essential" "footer" }}
      <menu>
        {{ range $data.Get . }}
        <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
        {{ end }}
      </menu>
      {{ end }}
    </section>

    <small>{{ partial "components/copyleft.html" . }}</small>
  </footer>
</body>
</html>
